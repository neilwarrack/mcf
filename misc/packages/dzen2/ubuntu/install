#!/usr/bin/env python3
# encoding: utf-8

import argparse
import subprocess

from stow import adopt_as
from git_repository import GitRepository


def install():
    with GitRepository('robm/dzen') as repo:
        # Comment option 1
        _replace('/No Xinerama no XPM no XFT/,+2s/^/#/', 'config.mk')
        # Uncomment option 7
        _replace('/With Xinerama and XPM and XFT/,+2s/^#//', 'config.mk')
        subprocess.call(['make'])
        subprocess.call(['sudo', 'make', 'install'])
        adopt_as('dzen2')


def is_installed():
    return subprocess.call(['bash', '-c', 'hash dzen2']) == 0


def _replace(e, f):
    cmd = ['sed', '-i', '-e', e, f]
    subprocess.call(cmd)


if __name__ == '__main__':
    parser = argparse.ArgumentParser(description='''
    Install dzen2 from source.
    ''', formatter_class=argparse.RawDescriptionHelpFormatter)
    parser.add_argument('--reinstall', action='store_true',
                        help='reinstall if dzen2 is already installed')
    args = parser.parse_args()
    if not args.reinstall and is_installed():
        print('Dzen2 is already installed. '
              'Pass --reinstall to force reinstallation.')
    else:
        install()
